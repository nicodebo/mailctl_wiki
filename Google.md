# Specific Instructions for Using `mailctl` with Google Accounts

## Setting up Google accounts for OAuth2

### Personal accounts

To start getting mails from your personal account you need to create
an `ID clients OAuth 2.0` from the google api console.

Follow the google api console at the following url:
https://console.cloud.google.com/apis

Create a new project.

Create a new `ID client OAuth`. The wizard should tell you that you
need to first set the `consent screen`. Follow the link on the help
popup.

Fill in the required fields of the `consent screen` form. Also add
your own email to the test users list.

Go back to the `ID client OAuth` form creation. It should now be
enable. Write down your `id` and `password`.

### Company/Institutional accounts

## Configuring `mailctl`

### `mailctl` with a personal google account

Copy the `google` section from `configs/services-template.yaml` (from
the mailctl repository) into `~/$XDG_CONFIG_HOME/mailctl/config.yaml`
and replace the `client_id` and `client_secret` with the one you
generated by [creating an id client OAuth](#personal-accounts)

Copy `configs/services-template.yaml` (from the mailctl repository)
into `~/$XDG_CONFIG_HOME/mailctl/services.yaml` and set your gpg key
id in the `encrypt_cmd` arguments section.

You can get your gpg key id with the following command:

	gpg --list-keys --keyid-format=long

The output looks like:

	pub   rsa2048/key_id YYYY-MM-DD [SC]

## Using `mailctl`

### Initial authorization

After [configuring](#mailctl-with-a-personal-google-account) mailctl
you need to execute the following command:

	mailctl authorize google youremail@gmail.com

Then follow `localhost:8080` on your browser like prompted on the
terminal and connect to your google account.

You should now have a new token located in
`~/.local/var/mailctl/youremail@gmail.com.auth`

Make sure the `refresh_token` value is not `null`.

You can decrypt the file with the following command:

	gpg --decrypt ~/.local/var/mailctl/youremail@gmail.com.auth

### Usage exemple with mbsync

You can see herebelow an exemple configuration file for mbsync. The
important line is the `PassCmd` which call the mailctl access
command. It automatically renew your token when it has expired
(1hour).

	IMAPAccount gmail
	# Address to connect to
	Host imap.gmail.com
	User n.debonnaire@gmail.com
	PassCmd "mailctl access youremail@gmail.com"
	# Use SSL
	SSLType IMAPS
	# The following line should work. If you get certificate errors, uncomment the two following lines and read the "Troubleshooting" section.
	CertificateFile /etc/ssl/certs/ca-certificates.crt
	#CertificateFile ~/.cert/imap.gmail.com.pem
	#CertificateFile ~/.cert/Equifax_Secure_CA.pem

	IMAPStore gmail-remote
	Account gmail

	MaildirStore gmail-local
	SubFolders Verbatim
	# The trailing "/" is important
	Path ~/Mail/gmail/
	Inbox ~/Mail/gmail/Inbox
